#! /bin/bash

set -e
export DEBIAN_FRONTEND=noninteractive

echo ">>> Saving manually installed packages"
PACKAGES=$(apt list --manual-installed 2>/dev/null | tail -n +2 | cut -d '/' -f 1)
echo ${PACKAGES}
echo ">>> Upgrade packages"
apt full-upgrade -q -y -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" < /dev/null
echo ">>> Reinstalling possibly removed packages"
apt install -q -y -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" ${PACKAGES} < /dev/null
echo ">>> Purge unneeded packages"
apt autopurge -q -y -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" < /dev/null
echo ">>> Clean package cache"
apt clean -q -y
